# 信号线逆向工程实验
> 说是为了记录下来，便于后人进一步研究。

本篇文章为逆向南科大二期宿舍门锁的过程记录，因为整个逆向的过程类似于实验，这里用实验的方式来指导动作和记录结果。

在阅读本文之前，你需要知道以下内容：
1. **二期宿舍门锁的基本功能**
TODO
2. **二期宿舍门锁的基本结构**
TODO
3. **Freedorm桥接板的基本功能**
TODO
4. **逻辑分析仪的基本功能**
TODO

## 实验目的

0. **了解信号线的基本功能**
1. **确定数据传输线的通讯协议**
2. **确定不同刷卡动作下的数据传输线的具体内容**
3. **不同权限卡之间的数据传输内容的区别**

## 实验器材
 1. **二期宿舍门锁**（研究对象）
 2. **Freedorm桥接板**（用来中间人截取信号）
 3. **逻辑分析仪**（用来获取分析信号）
 4. **数据线**（用来连接逻辑分析仪和上位机电脑）
 5. **杜邦线**（用来模拟短接调试线）
 6. **装有Pulseview的电脑**（用来分析信号）
 7. **对应的门禁卡**（用来执行刷卡成功动作）
 8. **空白门禁卡**（用来执行刷卡失败动作）
 9. **(optional) 宿管卡**（用来给逻辑分析仪供电）

最后安装好的实验器材如下图所示：
![实验器材](/reverse_engineering/README/setup.jpg)

## 实验步骤
0. 安装桥接版，具体步骤见[Freedorm安装教程](/TODO)
1. 连接逻辑分析仪和电脑
2. 开始录制信号
3. 执行实验动作

## 实验动作设计
针对每个实验目的，设计对应的实验动作，如下：
### 了解信号线的基本功能
![智慧赛宁logo](/reverse_engineering/README/snk_logo.jpg)
![dorm_pcb_silkprint](/reverse_engineering/README/pin_define.jpg)
![dorm_pcb_silkprint](/reverse_engineering/README/ph2_cable.jpg)
这一部分通过pcb板子上的丝印已经大概了解，8pin的ph2.0排线中，有两根线被剪断，分别是BUZ和SENSE，剩下的6根线分别是：GND、D1、D0、LED、LOCK、12V。

不浪费时间在没用到的线上和完全已知的线上，我们只关注D1、D0、LED、LOCK这四根线。

首先查询制造商[智慧赛宁](http://www.szsnk.com/)的资料，也没有翻到相关的资料，只能自己动手了。

通过测量电平，得到下表：
|      | D1  | D0   | LED | LOCK |
| ---- | --- | ---- | --- | ---- |
| 颜色 | 白  | 绿   | 橙  | 黄   |
| 电平 |     | TODO |     | TODO |
5V 
3V3
### 确定数据传输线的通讯协议

通过逻辑分析仪的分析，得到[一些数据]()，命名规则为`data_刷卡类型_对应反馈`。

刷卡类型有：
1. `admin`：宿管卡
2. `user`：本宿舍住户校园卡
3. `stranger`：陌生人校园卡
4. `touch_num`：点击门锁面板密码键盘数字键
5. `touch_ok`：点击门锁面板密码键盘确认键
6. `touch_cancel`：点击门锁面板密码键盘取消键
7. `blank`：空白UFUID-IC卡
8. `miband9`：小米手环9模拟IC卡

对应反馈有：
1. `success`：刷卡成功，门打开，且LED面板会有绿灯常亮，没有滴声，6秒后恢复锁门状态
2. `fail`：刷卡失败，门不打开，且LED面板会有红灯闪烁，伴有一声滴声
3. `blank`：没有反馈，门不打开，面板保持蓝色，没有滴声

通过实验，得到每种刷卡类型的对应反馈，如下表所示：
| 刷卡类型     | 门锁 | 面板LED    | 蜂鸣器 | 反馈类型 |
| ------------ | ---- | ---------- | ------ | -------- |
| admin        |      |            |        | success  |
| user         | 开   | 持续6s绿色 | 默     | success  |
| stranger     | 不开 | 红色闪烁3s | 长滴声 | fail     |
| touch_num    | 不开 |            |        | fail     |
| touch_ok     | 不开 |            |        | blank    |
| touch_cancel | 不开 |            |        | blank    |
| blank        | 不开 |            |        | blank    |
| miband9      | 不开 |            |        | blank    |
