# 信号线逆向工程实验
> 记录下来说是便于后人进一步研究。

- [信号线逆向工程实验](#信号线逆向工程实验)
  - [实验目的](#实验目的)
  - [实验器材](#实验器材)
  - [实验步骤](#实验步骤)
  - [实验动作设计](#实验动作设计)
  - [实验结果](#实验结果)
    - [信号线电平](#信号线电平)
    - [逻辑分析仪数据](#逻辑分析仪数据)
  - [实验数据分析](#实验数据分析)
    - [硬件分析](#硬件分析)
    - [信号线的基本功能](#信号线的基本功能)
    - [确定不同刷卡动作下的数据传输线的具体内容](#确定不同刷卡动作下的数据传输线的具体内容)


本篇文章为逆向南科大二期宿舍门锁的过程记录，因为整个逆向的过程类似于实验，这里用实验的方式来指导动作和记录结果。

在阅读本文之前，你需要知道以下内容：
1. **二期宿舍门锁的基本功能**
TODO
2. **二期宿舍门锁的基本结构**
TODO
3. **Freedorm桥接板的基本功能**
TODO
4. **逻辑分析仪的基本功能**
TODO

## 实验目的

0. **了解信号线的基本功能**
1. **确定数据传输线的通讯协议**
2. **确定数据传输和开门的流程**
3. **确定不同刷卡动作下的数据传输线的具体内容**
4. **不同权限卡之间的数据传输内容的区别**

## 实验器材
 0. **二期宿舍门锁**（研究对象）
 1. **Freedorm桥接板**（用来中间人截取信号）
 2. **逻辑分析仪**（用来获取分析信号）
 3. **数据线**（用来连接逻辑分析仪和上位机电脑）
 4. **杜邦线**（用来模拟短接调试线）
 5. **装有Pulseview的电脑**（用来分析信号）
 6. **对应的门禁卡**（用来执行刷卡成功动作）
 7. **空白门禁卡**（用来执行刷卡失败动作）
 8. **(optional) 宿管卡**（用来给逻辑分析仪供电）

最后安装好的实验器材如下图所示：
![实验器材](/reverse_engineering/README/setup.jpg)

## 实验步骤
0. 安装桥接版，具体步骤见[Freedorm安装教程](/TODO)
1. 测量信号线电平并记录
3. 连接逻辑分析仪和电脑
4. 开始录制信号
5. 执行实验动作
6. 按照命名规则保存数据

## 实验动作设计
针对每个实验目的，设计对应的实验动作，如下：

## 实验结果
### 信号线电平

通过测量对GND电平，得到下表：
|      | D1  | D0  | LED | LOCK |
| ---- | --- | --- | --- | ---- |
| 颜色 | 白  | 绿  | 橙  | 黄   |
| 电平 | 5V  | 5V  | 3V3 | 3V3  |

 

### 逻辑分析仪数据

通过执行刷卡动作，逻辑分析仪得到[一些数据]()，命名规则为`data_刷卡动作_对应反馈`。

刷卡动作有（比较感兴趣的进行了加粗）：
1. **`admin`：宿管卡**
2. **`user`：本宿舍住户校园卡**
3. **`stranger`：陌生人校园卡**
4. **`touch_num`：点击门锁面板密码键盘数字键**
5. **`touch_ok`：点击门锁面板密码键盘确认键**
6. `blank`：空白UFUID-IC卡
7. `miband9`：小米手环9模拟IC卡
8. **`D1`: 短接D1和GND**
9. **`D0`: 短接D0和GND**
10. **`LED`: 短接LED和GND**
11. **`LOCK`: 短接LOCK和GND**
12. **`D1&user`: 短接D1和GND，刷本宿舍住户校园卡**
13. `D0&user`: 短接D0和GND，刷本宿舍住户校园卡
14. `LED&user`: 短接LED和GND，刷本宿舍住户校园卡
15. `LOCK&user`: 短接LOCK和GND，刷本宿舍住户校园卡
16. **`D1&admin`: 短接D1和GND，刷宿管卡**
17. **`D0&admin`: 短接D0和GND，刷宿管卡**

对应反馈有：
1. `success`：门打开
2. `fail`：门不打开
3. `blank`：没有反馈，门不打开
4. `locked`：门锁上了，刷卡刷不开

#### 刷卡动作-反馈类型对应表

通过实验，得到每种刷卡动作的对应反馈表，如下表所示：
| 刷卡动作      | 门锁           | 面板LED                  | 蜂鸣器   | 反馈类型 |
| ------------- | -------------- | ------------------------ | -------- | -------- |
| **admin**     | 开，6s后锁上   | 持续6s绿色               | 长滴一声 | success  |
| **user**      | 开，6s后锁上   | 持续6s绿色               | 长滴一声 | success  |
| **stranger**  | 不开           | 红色闪烁3s               | 长滴一声 | fail     |
| **touch_num** | 不开           | 无反应                   | 短滴一声 | blank    |
| **touch_ok**  | 不开           | 绿色闪烁5s               | 默       | fail     |
| blank         | 不开           | 无反应                   | 默       | blank    |
| miband9       | 不开           | 无反应                   | 默       | blank    |
| D1            | 不开           | 保持蓝色                 | 默       | blank    |
| D0            | 不开           | 保持蓝色                 | 默       | blank    |
| LED           | 不开           | 蓝色变成绿色，并保持绿色 | 默       | blank    |
| **LOCK**      | **常开**       | 保持蓝色                 | 默       | success  |
| **D1&user**   | **不开**       | 绿色闪烁一下，1s         | 长滴一声 | locked   |
| **D0&user**   | **不开**       | 绿色闪烁一下，1s         | 长滴一声 | lockde   |
| LED&user      | 开，6s后锁上   | 持续6s绿色               | 长滴一声 | blank    |
| LOCK&user     | 本来就是常开的 | 持续6s绿色               | 长滴一声 | success  |
| **D1&admin**  |                |                          |          |          |
| **D0&admin**  |                |                          |          |          |

有太多种可能的刷卡动作，因此选取了感兴趣的11个刷卡动作，用逻辑分析仪获取数据。
每个数据对应一个动作；有4个通道，对应D1、D0、LED、LOCK。储存在[data文件夹下](/reverse_engineering/data)。

## 实验数据分析
### 硬件分析
在真正开始逆向之前，我们需要了解硬件的基本情况，我们来看看用了什么硬件。
### 信号线的基本功能

首先查询制造商[智慧赛宁](http://www.szsnk.com/)的资料，也没有翻到相关的资料，只能自己动手了。

![智慧赛宁logo](/reverse_engineering/README/snk_logo.jpg)

这一部分通过pcb板子上的丝印已经大概了解，8pin的ph2.0排线中，有两根线被剪断，分别是BUZ和SENSE，剩下的6根线分别是：GND、D1、D0、LED、LOCK、12V。

![dorm_pcb_silkprint](/reverse_engineering/README/pin_define.jpg)
![dorm_pcb_silkprint](/reverse_engineering/README/ph2_cable.jpg)

暂时不浪费时间在没用到的线（BUZ和SENCE）上和完全已知（12V和GND）的线上，我们只关注D1、D0、LED、LOCK这四根线。

通过查看按门板上数字的逻辑分析仪的数据 [data_touch_num_1234567890#_blank](reverse_engineering/data/data_touch_num_1234567890#_blank.sr)，这个数据是我分别单独按了`1`、`2`、`3`、`4`、`5`、`6`、`7`、`8`、`9`、`0`、`#`这11个数字键（没有按确认键`*`）

得到波形和对应数字二进制编码如下：
> 数字键1 `0001`：
> ![num_1](/reverse_engineering/README/num_1.png)

> 数字键2 `0010`：
> ![num_2](/reverse_engineering/README/num_2.png)

> 数字键3 `0011`：
> ![num_3](/reverse_engineering/README/num_3.png)

> 数字键4 `0100`：
> ![num_4](/reverse_engineering/README/num_4.png)

如果你对二进制足够熟悉，那应该能看到这些数字都是从左到右（大端序）四位二进制编码

#### 按键对应编码表
经过多次实验和统计，门板上的数字键的二进制编码如下：
| 按键              | 数字 | 二进制编码 |
| ----------------- | ---- | ---------- |
| 1                 | 1    | 0001       |
| 2                 | 2    | 0010       |
| 3                 | 3    | 0011       |
| 4                 | 4    | 0100       |
| 5                 | 5    | 0101       |
| 6                 | 6    | 0110       |
| 7                 | 7    | 0111       |
| 8                 | 8    | 1000       |
| 9                 | 9    | 1001       |
| 0                 | 0    | 0000       |
| *（确定键）       | 10   | 1011       |
| #  （不清楚功能） | 11   | 1010       |

所以D1和D0的功能确定了，D1是数据传输线，比特1；D0是数据传输线，比特0。

接下来我们来看看LED和LOCK这两根线的功能。

通过观察刷卡成功和失败的数据（），我们可以得到LED和LOCK的功能：

![data_user2success](/reverse_engineering/README/data_user2_success.png)
![data_stranger_fail](/reverse_engineering/README/data_stranger_fail.png)
配合上文的[刷卡动作反馈类型对应表]()

#### 信号线功能表
总结来说，假如GND和12V这两根线完全就是提供电源，6根线的功能如下：
| pcb丝印 | 信号线颜色 | 功能               |
| ------- | ---------- | ------------------ |
| D1      | 白         | 数据传输线，比特1  |
| D0      | 绿         | 数据传输线，比特0  |
| LED     | 橙         | 控制门锁面板指示灯 |
| LOCK    | 黄         | 控制门锁电机状态   |
| GND     | 黑         | 接地               |
| 12V     | 红         | 12V电源            |

### 确定不同刷卡动作下的数据传输线的具体内容

通过上述实验，我们得到了9种刷卡类型的反馈，下面我们分析每种刷卡动作的数据传输线的具体内容。

